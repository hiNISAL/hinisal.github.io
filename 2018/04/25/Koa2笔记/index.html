<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="NISAL"><link rel="alternative" href="/atom.xml" title="HIσ`∀´)σNISAL" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Koa2笔记 - HIσ`∀´)σNISAL</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">HIσ`∀´)σNISAL</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-04-24T18:48:06.000Z">April 25, 2018</time><h1 class="post__title"><a href="/2018/04/25/Koa2笔记/">Koa2笔记</a></h1><div class="post__main echo"><h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&apos;koa&apos;);</span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">  ctx.response.body = &apos;Hello World&apos;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(main);</span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="请求Accept-和响应类型"><a href="#请求Accept-和响应类型" class="headerlink" title="请求Accept 和响应类型"></a>请求Accept 和响应类型</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ctx.request.accepts(&apos;json&apos;)</span><br><span class="line"></span><br><span class="line">ctx.response.type = &apos;json&apos;;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="返回文件"><a href="#返回文件" class="headerlink" title="返回文件"></a>返回文件</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&apos;koa&apos;);</span><br><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">  ctx.response.type = &apos;html&apos;;</span><br><span class="line">  ctx.response.body = fs.createReadStream(&apos;./public/index.html&apos;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(main);</span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="原生路由"><a href="#原生路由" class="headerlink" title="原生路由"></a>原生路由</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&apos;koa&apos;);</span><br><span class="line">const fs = require(&apos;fs&apos;);</span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">  if (ctx.request.path !== &apos;/&apos;) &#123;</span><br><span class="line">    ctx.response.type = &apos;html&apos;;</span><br><span class="line">    ctx.response.body = &apos;&lt;a href=&quot;/&quot;&gt;Index&lt;/a&gt;&apos;;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    ctx.response.body = &apos;Hello World&apos;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(main);</span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="koa-route模块"><a href="#koa-route模块" class="headerlink" title="koa-route模块"></a>koa-route模块</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&apos;koa&apos;);</span><br><span class="line">const route = require(&apos;koa-route&apos;); // 安装模块</span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">const a = ctx =&gt; &#123;</span><br><span class="line">  ctx.response.body = &apos;Index&apos;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const b = ctx =&gt; &#123;</span><br><span class="line">  ctx.response.type = &apos;html&apos;;</span><br><span class="line">  ctx.response.body = &apos;&lt;a href=&quot;/&quot;&gt;Index&lt;/a&gt;&apos;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(route.get(&apos;/&apos;, a));</span><br><span class="line">app.use(route.get(&apos;/b&apos;, b));</span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="静态资源服务"><a href="#静态资源服务" class="headerlink" title="静态资源服务"></a>静态资源服务</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&apos;koa&apos;);</span><br><span class="line">const route = require(&apos;koa-route&apos;);</span><br><span class="line">const server = require(&apos;koa-static&apos;);</span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">const static = server(&apos;./public&apos;);</span><br><span class="line"></span><br><span class="line">app.use(static);</span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&apos;koa&apos;);</span><br><span class="line">const route = require(&apos;koa-route&apos;);</span><br><span class="line">const server = require(&apos;koa-static&apos;);</span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">const redirect = ctx =&gt; &#123;</span><br><span class="line">  ctx.response.redirect(&apos;/&apos;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const home = ctx =&gt; &#123;</span><br><span class="line">  ctx.response.body = &apos;HW&apos;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(route.get(&apos;/&apos;, home));</span><br><span class="line">app.use(route.get(&apos;/re&apos;, redirect));</span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="中间件和中间件栈"><a href="#中间件和中间件栈" class="headerlink" title="中间件和中间件栈"></a>中间件和中间件栈</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&apos;koa&apos;);</span><br><span class="line">const route = require(&apos;koa-route&apos;);</span><br><span class="line">const server = require(&apos;koa-static&apos;);</span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">const one = (ctx, next) =&gt; &#123;</span><br><span class="line">  console.log(&apos;&gt;&gt; one&apos;);</span><br><span class="line">  next();</span><br><span class="line">  console.log(&apos;&lt;&lt; one&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const two = (ctx, next) =&gt; &#123;</span><br><span class="line">  console.log(&apos;&gt;&gt; two&apos;);</span><br><span class="line">  next(); </span><br><span class="line">  console.log(&apos;&lt;&lt; two&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const three = (ctx, next) =&gt; &#123;</span><br><span class="line">  console.log(&apos;&gt;&gt; three&apos;);</span><br><span class="line">  next();</span><br><span class="line">  console.log(&apos;&lt;&lt; three&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(one);</span><br><span class="line">app.use(two);</span><br><span class="line">app.use(three);</span><br><span class="line"></span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<h1 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h1><h3 id="500"><a href="#500" class="headerlink" title="500"></a>500</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">  ctx.throw(500);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="404"><a href="#404" class="headerlink" title="404"></a>404</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">  ctx.response.status = 404;</span><br><span class="line">  ctx.response.body = &apos;Page Not Found&apos;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="利用最外层中间件捕获错误"><a href="#利用最外层中间件捕获错误" class="headerlink" title="利用最外层中间件捕获错误"></a>利用最外层中间件捕获错误</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const handler = async (ctx, next) =&gt; &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    await next();</span><br><span class="line">  &#125; catch (err) &#123;</span><br><span class="line">    ctx.response.status = err.statusCode || err.status || 500;</span><br><span class="line">    ctx.response.body = &#123;</span><br><span class="line">      message: err.message</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">  ctx.throw(500);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(handler);</span><br><span class="line">app.use(main);</span><br></pre></td></tr></table></figure>
<h3 id="Koa监听error事件"><a href="#Koa监听error事件" class="headerlink" title="Koa监听error事件"></a>Koa监听error事件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">  ctx.throw(500);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.on(&apos;error&apos;, (err, ctx) =&gt;</span><br><span class="line">  console.error(&apos;server error&apos;, err);</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="释放-error-事件"><a href="#释放-error-事件" class="headerlink" title="释放 error 事件"></a>释放 error 事件</h3><p>如果错误被<code>try...catch</code>捕获 就不会触发<code>error</code>事件 这时 必须调用<code>ctx.app.emit()</code> 手动释放error事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">const handler = async (ctx, next) =&gt; &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    await next();</span><br><span class="line">  &#125; catch (err) &#123;</span><br><span class="line">    ctx.response.status = err.statusCode || err.status || 500;</span><br><span class="line">    ctx.response.type = &apos;html&apos;;</span><br><span class="line">    ctx.response.body = &apos;&lt;p&gt;Something wrong, please contact administrator.&lt;/p&gt;&apos;;</span><br><span class="line">    ctx.app.emit(&apos;error&apos;, err, ctx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">  ctx.throw(500);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.on(&apos;error&apos;, function(err) &#123;</span><br><span class="line">  console.log(&apos;logging error &apos;, err.message);</span><br><span class="line">  console.log(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h3 id="post"><a href="#post" class="headerlink" title="post"></a>post</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">const Koa = require(&apos;koa&apos;);</span><br><span class="line">const route = require(&apos;koa-route&apos;);</span><br><span class="line">const server = require(&apos;koa-static&apos;);</span><br><span class="line">const koaBody = require(&apos;koa-body&apos;);</span><br><span class="line">const app = new Koa();</span><br><span class="line"></span><br><span class="line">app.use(koaBody());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const getInfo = ctx =&gt; &#123;</span><br><span class="line">  console.log(ctx.request.body);</span><br><span class="line">  ctx.response.type = &apos;json&apos;;</span><br><span class="line">  ctx.response.body = &#123;</span><br><span class="line">    status: true</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(server(&apos;./public&apos;));</span><br><span class="line">app.use(route.post(&apos;/getInfo&apos;, getInfo));</span><br><span class="line"></span><br><span class="line">app.listen(3000);</span><br></pre></td></tr></table></figure>
<h3 id="post-上传文件"><a href="#post-上传文件" class="headerlink" title="post 上传文件"></a>post 上传文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">const os = require(&apos;os&apos;);</span><br><span class="line">const path = require(&apos;path&apos;);</span><br><span class="line">const koaBody = require(&apos;koa-body&apos;);</span><br><span class="line"></span><br><span class="line">const main = async function(ctx) &#123;</span><br><span class="line">  const tmpdir = os.tmpdir();</span><br><span class="line">  const filePaths = [];</span><br><span class="line">  const files = ctx.request.body.files || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  for (let key in files) &#123;</span><br><span class="line">    const file = files[key];</span><br><span class="line">    const filePath = path.join(tmpdir, file.name);</span><br><span class="line">    const reader = fs.createReadStream(file.path);</span><br><span class="line">    const writer = fs.createWriteStream(filePath);</span><br><span class="line">    reader.pipe(writer);</span><br><span class="line">    filePaths.push(filePath);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ctx.body = filePaths;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(koaBody(&#123; multipart: true &#125;));</span><br></pre></td></tr></table></figure>
<h3 id="cookies"><a href="#cookies" class="headerlink" title="cookies"></a>cookies</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const main = function(ctx) &#123;</span><br><span class="line">  const n = Number(ctx.cookies.get(&apos;view&apos;) || 0) + 1;</span><br><span class="line">  ctx.cookies.set(&apos;view&apos;, n);</span><br><span class="line">  ctx.response.body = n + &apos; views&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></header></article><!--div.comments#lv-container(data-id = theme.livere_id, data-uid = theme.livere_uid)//script.
  //(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');--></main><footer class="foot"><div class="foot-copy">&copy; 2017-2018 NISAL</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>